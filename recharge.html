<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Deposit - FoxPro Exchange</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      .form-card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .form-card h3 {
        margin-bottom: 16px;
        font-weight: 600;
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-group label {
        display: block;
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 6px;
        font-weight: 500;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 10px 12px;
        background: var(--panel-2);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text);
        font-size: 13px;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: var(--primary);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .qr-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        margin: 16px 0;
      }

      .qr-code {
        width: 200px;
        height: 200px;
        background: var(--panel-2);
        margin: 0 auto 12px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: var(--muted);
      }

      .address-box {
        background: var(--panel-2);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 12px;
        margin: 12px 0;
        word-break: break-all;
        font-family: monospace;
        font-size: 12px;
        color: var(--text);
      }

      .copy-btn {
        padding: 8px 12px;
        background: var(--primary);
        border: 1px solid var(--primary);
        border-radius: 4px;
        color: white;
        font-size: 12px;
        cursor: pointer;
        width: 100%;
        margin-top: 8px;
      }

      .copy-btn:hover {
        opacity: 0.8;
      }

      .deposit-info {
        background: var(--panel-2);
        border-left: 3px solid var(--primary);
        border-radius: 4px;
        padding: 12px;
        margin: 12px 0;
        font-size: 12px;
        line-height: 1.6;
      }

      .deposit-info strong {
        color: var(--primary);
      }

      .deposit-list {
        margin-top: 20px;
      }

      .deposit-item {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .deposit-item-left {
        flex: 1;
      }

      .deposit-item-title {
        font-weight: 600;
        color: var(--text);
        margin-bottom: 4px;
      }

      .deposit-item-time {
        font-size: 12px;
        color: var(--muted);
      }

      .deposit-item-amount {
        text-align: right;
      }

      .deposit-item-value {
        font-weight: 600;
        color: var(--text);
        margin-bottom: 4px;
      }

      .deposit-status {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 4px;
        background: var(--warning);
        color: white;
      }

      .deposit-status.success {
        background: var(--success);
      }

      .deposit-status.confirmed {
        background: var(--primary);
      }

      .tabs {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 12px;
      }

      .tab {
        background: none;
        border: none;
        color: var(--muted);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        padding-bottom: 8px;
        border-bottom: 2px solid transparent;
      }

      .tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }

      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
        }

        .deposit-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
        }

        .deposit-item-amount {
          text-align: left;
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header class="topbar">
        <div class="topbar-header">
          <div class="topbar-left">
            <div class="logo">FoxPro<span>Exchange</span></div>
          </div>
          <div class="topbar-right">
            <a href="#" id="supportLink" title="Customer Support" style="color: var(--primary); font-size: 18px; text-decoration: none; display: none; margin-right: 12px;">
              ğŸ’¬
            </a>
          </div>
        </div>
        <div class="topbar-nav-wrapper">
          <nav class="main-nav">
            <a href="index.html" class="nav-link">Home</a>
            <a href="market.html" class="nav-link">Markets</a>
            <a href="trade.html" class="nav-link">Trade</a>
            <a href="assets.html" class="nav-link">Assets</a>
            <a href="account.html" class="nav-link">Account</a>
          </nav>
        </div>
      </header>

      <!-- Login Prompt -->
      <div id="loginPrompt" style="text-align: center; padding: 40px 20px; background: rgba(59, 130, 246, 0.08); border-radius: 12px; margin-bottom: 20px;">
        <h2 style="font-size: 20px; margin-bottom: 12px;">Sign in to deposit</h2>
        <p style="color: var(--muted); margin-bottom: 16px; font-size: 14px;">Add funds to your account to start trading</p>
        <div style="display: flex; gap: 12px;">
          <button class="btn" style="flex: 1; background: var(--primary); color: white;" onclick="window.location.href='login.html'">Sign In</button>
          <button class="btn" style="flex: 1; background: none; border: 1px solid var(--border); color: var(--text);" onclick="window.location.href='register.html'">Create Account</button>
        </div>
      </div>

      <div id="content-area">
      <h2 style="margin-bottom: 20px;">Deposit Cryptocurrency</h2>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab('deposit')">Deposit</button>
        <button class="tab" onclick="switchTab('history')">Deposit History</button>
      </div>

      <!-- Deposit Form -->
      <div id="deposit-tab" style="display: block;">
        <div class="form-card">
          <h3>ğŸ’° é€‰æ‹©å……å€¼å¸ç§?/h3>
          <div class="form-group">
            <label>å¸ç§</label>
            <select id="coinSelect" onchange="updateCoinInfo()">
              <option value="">åŠ è½½ä¸?..</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>å……å€¼ç½‘ç»?/label>
              <input type="text" id="networkDisplay" disabled value="-" style="background: var(--panel-2); cursor: not-allowed;" />
            </div>
            <div class="form-group">
              <label>æœ€å°å……å€¼é¢</label>
              <input type="text" id="minDeposit" disabled value="-" style="background: var(--panel-2); cursor: not-allowed;" />
            </div>
          </div>
        </div>

        <!-- äºŒç»´ç å’Œåœ°å€ -->
        <div class="form-card">
          <h3>ğŸ“± å……å€¼åœ°å€</h3>
          <div style="text-align: center; margin-bottom: 20px;">
            <div id="qrCodeContainer" style="display: inline-block; padding: 20px; background: var(--panel-2); border-radius: 8px; min-width: 250px;">
              <img id="qrCode" src="" alt="QR Code" style="width: 200px; height: 200px; border: 2px solid var(--border); border-radius: 4px; display: none;" />
              <div id="qrPlaceholder" style="width: 200px; height: 200px; display: flex; align-items: center; justify-content: center; color: var(--muted);">é€‰æ‹©å¸ç§æ˜¾ç¤ºäºŒç»´ç ?/div>
            </div>
          </div>
          <div class="form-group">
            <label>å……å€¼é’±åŒ…åœ°å€</label>
            <div style="display: flex; gap: 10px;">
              <input type="text" id="depositAddress" readonly value="-" style="background: var(--panel-2); cursor: not-allowed; flex: 1; word-break: break-all;" />
              <button class="copy-btn" onclick="copyAddress()" style="padding: 8px 16px; min-width: 100px;">ğŸ“‹ å¤åˆ¶</button>
            </div>
          </div>
        </div>

        <!-- å……å€¼é‡‘é¢?-->
        <div class="form-card">
          <h3>ğŸ“Š å……å€¼æ•°é‡?/h3>
          <div class="form-group">
            <label>å……å€¼é‡‘é¢?/label>
            <input type="number" id="rechargeAmount" placeholder="è¾“å…¥å……å€¼æ•°é‡? step="0.00000001" min="0" />
          </div>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 16px;">
            <button class="quick-amount-btn" onclick="setRechargeAmount(0.1)">0.1</button>
            <button class="quick-amount-btn" onclick="setRechargeAmount(0.5)">0.5</button>
            <button class="quick-amount-btn" onclick="setRechargeAmount(1)">1.0</button>
            <button class="quick-amount-btn" onclick="setRechargeAmount(5)">5.0</button>
          </div>
        </div>

        <!-- æäº¤å……å€?-->
        <div class="form-card">
          <h3>âœ?ç¡®è®¤å……å€?/h3>
          <div style="background: var(--panel-2); padding: 15px; border-radius: 6px; margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span style="color: var(--muted);">å¸ç§</span>
              <span style="color: var(--text); font-weight: 600;" id="confirmCoin">-</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span style="color: var(--muted);">é‡‘é¢</span>
              <span style="color: var(--text); font-weight: 600;" id="confirmAmount">0</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--muted);">ç½‘ç»œ</span>
              <span style="color: var(--text); font-weight: 600;" id="confirmNetwork">-</span>
            </div>
          </div>
          <button class="submit-btn" onclick="submitRecharge()">âœ?æäº¤å……å€¼ç”³è¯?/button>
        </div>

        <!-- é‡è¦æç¤º -->
        <div class="form-card">
          <h3>âš ï¸ é‡è¦æç¤º</h3>
          <div class="deposit-info">
            <strong>é€‰æ‹©æ­£ç¡®çš„ç½‘ç»œï¼š</strong> ä½¿ç”¨é”™è¯¯çš„ç½‘ç»œå¯èƒ½å¯¼è‡´èµ„é‡‘æ°¸ä¹…ä¸§å¤±ã€‚è¯·ç¡®ä¿é€‰æ‹©ä¸å‘é€åœ°å€ç›¸åŒçš„ç½‘ç»œã€?
          </div>
          <div class="deposit-info">
            <strong>æœ€å°å……å€¼é‡‘é¢ï¼š</strong> <span id="minAmountDisplay">-</span>
          </div>
          <div class="deposit-info">
            <strong>åˆ°è´¦æ—¶é—´ï¼?/strong> é€šå¸¸åœ¨åŒºå—é“¾ç¡®è®¤å?10-30 åˆ†é’Ÿå†…åˆ°è´¦ã€?
          </div>
          <div class="deposit-info">
            <strong>æœ‰é—®é¢˜ï¼Ÿ</strong> è¯·è”ç³»æˆ‘ä»¬çš„<a href="customer-support.html" style="color: var(--primary); text-decoration: underline;">å®¢æœä¸­å¿ƒ</a>
          </div>
        </div>
      </div>

      <!-- Deposit History -->
      <div id="history-tab" style="display: none;">
        <div class="form-card">
          <h3>ğŸ’³ å……å€¼è®°å½?/h3>
          <div style="margin-bottom: 15px;">
            <button class="submit-btn" onclick="loadMyRechargeOrders()" style="background: var(--primary); margin: 0; width: auto; padding: 8px 16px;">ğŸ”„ åˆ·æ–°è®°å½•</button>
          </div>
          <div class="deposit-list" id="rechargeOrdersList">
            <div style="text-align: center; color: var(--muted); padding: 20px;">åŠ è½½ä¸?..</div>
          </div>
        </div>
      </div>
      </div>
    </div>

    <script src="auth.js"></script>
    <script>
      const API_BASE = 'http://localhost:3000';
      let rechargeConfigs = {};
      let currentConfig = null;

      function switchTab(tab) {
        document.querySelectorAll('[id$="-tab"]').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
        
        if (tab === 'deposit') {
          document.getElementById('deposit-tab').style.display = 'block';
          document.querySelectorAll('.tab')[0].classList.add('active');
        } else {
          document.getElementById('history-tab').style.display = 'block';
          document.querySelectorAll('.tab')[1].classList.add('active');
          loadMyRechargeOrders();
        }
      }

      async function loadRechargeConfig() {
        try {
          const res = await fetch(`${API_BASE}/api/recharge/config`);
          const data = await res.json();
          
          if (data.success && Array.isArray(data.data)) {
            rechargeConfigs = {};
            const select = document.getElementById('coinSelect');
            select.innerHTML = '<option value="">é€‰æ‹©å¸ç§...</option>';
            
            data.data.forEach(config => {
              rechargeConfigs[config.coin] = config;
              select.innerHTML += `<option value="${config.coin}">${config.coin}</option>`;
            });
          }
        } catch (err) {
          console.error('Error loading recharge config:', err);
        }
      }

      function updateCoinInfo() {
        const coin = document.getElementById('coinSelect').value;
        
        if (!coin || !rechargeConfigs[coin]) {
          document.getElementById('networkDisplay').value = '-';
          document.getElementById('minDeposit').value = '-';
          document.getElementById('minAmountDisplay').textContent = '-';
          document.getElementById('confirmCoin').textContent = '-';
          document.getElementById('confirmNetwork').textContent = '-';
          document.getElementById('depositAddress').value = '-';
          document.getElementById('qrCode').style.display = 'none';
          document.getElementById('qrPlaceholder').style.display = 'flex';
          currentConfig = null;
          return;
        }

        currentConfig = rechargeConfigs[coin];
        document.getElementById('networkDisplay').value = currentConfig.network;
        document.getElementById('minDeposit').value = currentConfig.minAmount + ' ' + coin;
        document.getElementById('minAmountDisplay').textContent = currentConfig.minAmount + ' ' + coin;
        document.getElementById('confirmCoin').textContent = coin;
        document.getElementById('confirmNetwork').textContent = currentConfig.network;
        document.getElementById('depositAddress').value = currentConfig.address;
        
        // æ˜¾ç¤ºäºŒç»´ç ?
        if (currentConfig.qrCodeUrl) {
          const qrImg = document.getElementById('qrCode');
          qrImg.src = currentConfig.qrCodeUrl;
          qrImg.style.display = 'block';
          document.getElementById('qrPlaceholder').style.display = 'none';
        } else {
          document.getElementById('qrCode').style.display = 'none';
          document.getElementById('qrPlaceholder').style.display = 'flex';
        }
      }

      function setRechargeAmount(amount) {
        document.getElementById('rechargeAmount').value = amount;
        document.getElementById('confirmAmount').textContent = amount + ' ' + (currentConfig?.coin || '-');
      }

      document.getElementById('rechargeAmount')?.addEventListener('input', function() {
        const coin = document.getElementById('coinSelect').value;
        document.getElementById('confirmAmount').textContent = (this.value || '0') + ' ' + (coin || '-');
      });

      function copyAddress() {
        const address = document.getElementById('depositAddress').value;
        if (address && address !== '-') {
          navigator.clipboard.writeText(address).then(() => {
            alert('âœ?åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ?);
          }).catch(() => {
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
          });
        }
      }

      async function submitRecharge() {
        const token = localStorage.getItem('userToken');
        if (!token) {
          window.location.href = 'login.html';
          return;
        }

        const coin = document.getElementById('coinSelect').value;
        const amount = parseFloat(document.getElementById('rechargeAmount').value);
        const network = currentConfig?.network;

        if (!coin || !amount || amount <= 0) {
          alert('è¯·é€‰æ‹©å¸ç§å¹¶è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢');
          return;
        }

        if (currentConfig && amount < currentConfig.minAmount) {
          alert(`æœ€å°å……å€¼é‡‘é¢ä¸º ${currentConfig.minAmount} ${coin}`);
          return;
        }

        try {
          const res = await fetch(`${API_BASE}/api/recharge/submit`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              coin,
              amount,
              network
            })
          });

          const data = await res.json();
          if (data.success) {
            alert(`âœ?å……å€¼ç”³è¯·å·²æäº¤ï¼è®¢å•ID: ${data.data.id}`);
            document.getElementById('rechargeAmount').value = '';
            document.getElementById('confirmAmount').textContent = '0';
            setTimeout(() => loadMyRechargeOrders(), 500);
          } else {
            alert('âœ?æäº¤å¤±è´¥ï¼? + (data.error || data.message));
          }
        } catch (err) {
          console.error('Error:', err);
          alert('æäº¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ?);
        }
      }

      async function loadMyRechargeOrders() {
        const token = localStorage.getItem('userToken');
        if (!token) {
          document.getElementById('rechargeOrdersList').innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">è¯·å…ˆç™»å½•</div>';
          return;
        }

        try {
          const res = await fetch(`${API_BASE}/api/recharge/myorders`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await res.json();

          const container = document.getElementById('rechargeOrdersList');
          if (data.success && Array.isArray(data.data)) {
            if (data.data.length === 0) {
              container.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">æš‚æ— å……å€¼è®°å½?/div>';
            } else {
              container.innerHTML = data.data.map(order => {
                let statusClass = '';
                let statusText = '';
                if (order.status === 'pending') {
                  statusClass = 'confirmed';
                  statusText = 'â?å¾…ç¡®è®?;
                } else if (order.status === 'completed') {
                  statusClass = 'success';
                  statusText = 'âœ?å·²å®Œæˆ?;
                } else if (order.status === 'rejected') {
                  statusClass = 'rejected';
                  statusText = 'âœ?å·²æ‹’ç»?;
                }

                return `
                  <div class="deposit-item">
                    <div class="deposit-item-left">
                      <div class="deposit-item-title">${order.coin} - ${order.network || 'mainnet'}</div>
                      <div class="deposit-item-time">${new Date(order.createdAt).toLocaleString('zh-CN')}</div>
                      ${order.txHash ? `<div style="margin-top: 8px; font-size: 11px; color: var(--muted); word-break: break-all;"><strong>TxHashï¼?/strong> ${order.txHash}</div>` : ''}
                    </div>
                    <div class="deposit-item-amount">
                      <div class="deposit-item-value">+${parseFloat(order.amount).toFixed(6)} ${order.coin}</div>
                      <span class="deposit-status ${statusClass}">${statusText}</span>
                    </div>
                  </div>
                `;
              }).join('');
            }
          } else {
            container.innerHTML = '<div style="text-align: center; color: var(--danger); padding: 20px;">åŠ è½½å¤±è´¥</div>';
          }
        } catch (err) {
          console.error('Error loading recharge orders:', err);
          document.getElementById('rechargeOrdersList').innerHTML = '<div style="text-align: center; color: var(--danger); padding: 20px;">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
        }
      }

      function updateAuthDisplay() {
        const authButtons = document.getElementById('authButtons');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        
        if (isLoggedIn()) {
          if (authButtons) authButtons.style.display = 'none';
          if (loginBtn) loginBtn.style.display = 'none';
          if (registerBtn) registerBtn.style.display = 'none';
        } else {
          if (authButtons) authButtons.style.display = 'flex';
          if (loginBtn) loginBtn.style.display = 'block';
          if (registerBtn) registerBtn.style.display = 'block';
        }
      }

      async function loadSupportLink() {
        try {
          const supportLink = document.getElementById('supportLink');
          if (supportLink) {
            supportLink.href = 'customer-support.html';
            supportLink.style.display = 'inline-block';
            supportLink.title = 'Customer Support';
          }
        } catch (error) {
          console.error('Error loading support link:', error);
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        updateNavbar();
        loadSupportLink();
        loadRechargeConfig();
        updateAuthDisplay();
        const user = getCurrentUser();
        const loginPrompt = document.getElementById('loginPrompt');
        const contentArea = document.getElementById('content-area');
        
        if (!user) {
          if (loginPrompt) loginPrompt.style.display = 'block';
          if (contentArea) contentArea.style.display = 'none';
          return;
        }
        if (loginPrompt) loginPrompt.style.display = 'none';
        if (contentArea) contentArea.style.display = 'block';
        updateCoinInfo();
      });
    </script>
  </body>
</html>

